<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登入修復測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        input {
            width: 200px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🔧 登入修復測試頁面</h1>
    
    <div class="test-section">
        <h2 class="test-title">1. JSON 特殊字符處理測試</h2>
        <div>
            <label>測試密碼: </label>
            <input type="text" id="testPassword" value="Admin123!" placeholder="輸入包含特殊字符的密碼">
            <button onclick="testJSONEscape()">測試JSON轉義</button>
        </div>
        <div id="jsonResult" class="test-result info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">2. 密碼驗證測試</h2>
        <div>
            <label>用戶名: </label>
            <input type="text" id="username" value="admin" placeholder="用戶名">
            <br>
            <label>密碼: </label>
            <input type="password" id="password" value="Admin123" placeholder="密碼">
            <br>
            <button onclick="testLogin()">測試登入</button>
            <button onclick="testDebugEndpoint()">調試診斷</button>
        </div>
        <div id="loginResult" class="test-result info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">3. API 健康檢查</h2>
        <div>
            <button onclick="testAPIHealth()">檢查 API 狀態</button>
            <button onclick="testAdminDebug()">調試 Admin 用戶</button>
        </div>
        <div id="healthResult" class="test-result info" style="display: none;"></div>
    </div>

    <script>
        // 導入我們修復的 JSON 工具函數
        function safeJSONStringify(obj) {
            try {
                return JSON.stringify(obj, (key, value) => {
                    if (typeof value === 'string') {
                        return value // 保持原樣，不進行額外轉義
                    }
                    return value
                })
            } catch (error) {
                console.error('JSON序列化失敗:', error)
                throw new Error('數據序列化失敗')
            }
        }

        function escapeSpecialChars(str) {
            if (typeof str !== 'string') return str
            
            return str
                .replace(/\\/g, '\\\\')  // 反斜杠
                .replace(/"/g, '\\"')    // 雙引號
                .replace(/'/g, "\\'")    // 單引號
                .replace(/\n/g, '\\n')   // 換行符
                .replace(/\r/g, '\\r')   // 回車符
                .replace(/\t/g, '\\t')   // 制表符
        }

        function createSafeLoginPayload(credentials) {
            const payload = {
                username: credentials.username.trim(),
                password: credentials.password, // 密碼保持原樣
                rememberMe: credentials.rememberMe || false
            }
            
            if (credentials.mfa_code) {
                payload.mfa_code = credentials.mfa_code.trim()
            }
            
            return payload
        }

        // 測試函數
        function testJSONEscape() {
            const password = document.getElementById('testPassword').value;
            const result = document.getElementById('jsonResult');
            result.style.display = 'block';
            
            try {
                // 測試原始JSON.stringify
                let originalJSON;
                try {
                    originalJSON = JSON.stringify({ password: password });
                    result.innerHTML += `<strong>✅ 原始JSON.stringify成功:</strong><br>${originalJSON}<br><br>`;
                    result.className = 'test-result success';
                } catch (e) {
                    result.innerHTML += `<strong>❌ 原始JSON.stringify失敗:</strong><br>${e.message}<br><br>`;
                    result.className = 'test-result error';
                }

                // 測試安全版本
                const safeJSON = safeJSONStringify({ password: password });
                result.innerHTML += `<strong>✅ 安全JSON序列化成功:</strong><br>${safeJSON}<br><br>`;
                
                // 測試創建登入負載
                const payload = createSafeLoginPayload({
                    username: 'admin',
                    password: password,
                    rememberMe: false
                });
                const payloadJSON = safeJSONStringify(payload);
                result.innerHTML += `<strong>✅ 登入負載創建成功:</strong><br>${payloadJSON}<br><br>`;
                
                if (result.className !== 'test-result error') {
                    result.className = 'test-result success';
                }
            } catch (error) {
                result.innerHTML += `<strong>❌ 測試失敗:</strong><br>${error.message}`;
                result.className = 'test-result error';
            }
        }

        async function testAPIHealth() {
            const result = document.getElementById('healthResult');
            result.style.display = 'block';
            result.innerHTML = '🔍 檢查 API 健康狀態...<br>';
            
            // 定義多個API端點進行測試
            const apiEndpoints = [
                { name: '直接後端連接', url: 'http://localhost:8090/api/admin/auth/test' },
                { name: 'Nginx代理連接', url: '/api/admin/auth/test' },
                { name: '備用健康檢查', url: '/api/health' }
            ];
            
            for (const endpoint of apiEndpoints) {
                try {
                    result.innerHTML += `<br>📡 測試 ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        const data = await response.json();
                        result.innerHTML += `<strong>✅ ${endpoint.name} 成功:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result success';
                        return; // 有一個成功就結束
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    result.innerHTML += `<strong>❌ ${endpoint.name} 失敗:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>⚠️ 所有API端點都無法連接</strong><br>`;
        }

        async function testAdminDebug() {
            const result = document.getElementById('healthResult');
            result.style.display = 'block';
            result.innerHTML = '🔍 調試 Admin 用戶...<br>';
            
            // 測試多個調試端點
            const debugEndpoints = [
                { name: '直接後端調試', url: 'http://localhost:8090/api/admin/auth/debug/test-admin' },
                { name: 'Nginx代理調試', url: '/api/admin/auth/debug/test-admin' }
            ];
            
            for (const endpoint of debugEndpoints) {
                try {
                    result.innerHTML += `<br>🔧 測試 ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        const data = await response.json();
                        result.innerHTML += `<strong>✅ ${endpoint.name} 成功:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result success';
                        return;
                    } else {
                        result.innerHTML += `<strong>❌ ${endpoint.name} HTTP錯誤:</strong> ${response.status}<br>`;
                    }
                } catch (error) {
                    result.innerHTML += `<strong>❌ ${endpoint.name} 連接失敗:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>⚠️ 所有調試端點都無法連接</strong><br>`;
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginResult');
            result.style.display = 'block';
            result.innerHTML = '🔐 測試登入...<br>';
            
            // 創建安全的登入負載
            const payload = createSafeLoginPayload({
                username: username,
                password: password,
                rememberMe: false
            });
            
            result.innerHTML += `<strong>📦 登入負載:</strong><br><pre>${safeJSONStringify(payload)}</pre><br>`;
            
            // 測試多個登入端點
            const loginEndpoints = [
                { name: '直接後端登入', url: 'http://localhost:8090/api/admin/auth/login' },
                { name: 'Nginx代理登入', url: '/api/admin/auth/login' }
            ];
            
            for (const endpoint of loginEndpoints) {
                try {
                    result.innerHTML += `<br>🔐 嘗試 ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: safeJSONStringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        result.innerHTML += `<strong>✅ ${endpoint.name} 成功:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result success';
                        return;
                    } else {
                        result.innerHTML += `<strong>❌ ${endpoint.name} 失敗:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                    }
                } catch (error) {
                    result.innerHTML += `<strong>❌ ${endpoint.name} 連接失敗:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>⚠️ 所有登入端點都無法連接</strong><br>`;
        }

        async function testDebugEndpoint() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginResult');
            result.style.display = 'block';
            result.innerHTML = '🔍 運行登入診斷...<br>';
            
            const payload = createSafeLoginPayload({
                username: username,
                password: password
            });
            
            // 測試多個診斷端點
            const diagnosisEndpoints = [
                { name: '直接後端診斷', url: 'http://localhost:8090/api/admin/auth/debug/login-diagnosis' },
                { name: 'Nginx代理診斷', url: '/api/admin/auth/debug/login-diagnosis' }
            ];
            
            for (const endpoint of diagnosisEndpoints) {
                try {
                    result.innerHTML += `<br>🔍 嘗試 ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: safeJSONStringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        result.innerHTML += `<strong>📊 ${endpoint.name} 診斷結果:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result info';
                        return;
                    } else {
                        result.innerHTML += `<strong>❌ ${endpoint.name} 診斷失敗:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                    }
                } catch (error) {
                    result.innerHTML += `<strong>❌ ${endpoint.name} 連接失敗:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>⚠️ 所有診斷端點都無法連接</strong><br>`;
        }

        // 頁面加載時顯示基本信息
        window.onload = function() {
            console.log('🔧 登入修復測試頁面已載入');
            console.log('修復內容:');
            console.log('1. ✅ 數據庫admin密碼更新為Admin123(無感嘆號)');
            console.log('2. ✅ 前端JSON轉義問題修復');
            console.log('3. ✅ 後端錯誤處理增強');
            console.log('4. ✅ 調試模式和診斷信息添加');
            console.log('請使用上述測試功能驗證修復效果');
        }
    </script>
</body>
</html>