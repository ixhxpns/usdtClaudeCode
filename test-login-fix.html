<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å…¥ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        input {
            width: 200px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç™»å…¥ä¿®å¾©æ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h2 class="test-title">1. JSON ç‰¹æ®Šå­—ç¬¦è™•ç†æ¸¬è©¦</h2>
        <div>
            <label>æ¸¬è©¦å¯†ç¢¼: </label>
            <input type="text" id="testPassword" value="Admin123!" placeholder="è¼¸å…¥åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å¯†ç¢¼">
            <button onclick="testJSONEscape()">æ¸¬è©¦JSONè½‰ç¾©</button>
        </div>
        <div id="jsonResult" class="test-result info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">2. å¯†ç¢¼é©—è­‰æ¸¬è©¦</h2>
        <div>
            <label>ç”¨æˆ¶å: </label>
            <input type="text" id="username" value="admin" placeholder="ç”¨æˆ¶å">
            <br>
            <label>å¯†ç¢¼: </label>
            <input type="password" id="password" value="Admin123" placeholder="å¯†ç¢¼">
            <br>
            <button onclick="testLogin()">æ¸¬è©¦ç™»å…¥</button>
            <button onclick="testDebugEndpoint()">èª¿è©¦è¨ºæ–·</button>
        </div>
        <div id="loginResult" class="test-result info" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2 class="test-title">3. API å¥åº·æª¢æŸ¥</h2>
        <div>
            <button onclick="testAPIHealth()">æª¢æŸ¥ API ç‹€æ…‹</button>
            <button onclick="testAdminDebug()">èª¿è©¦ Admin ç”¨æˆ¶</button>
        </div>
        <div id="healthResult" class="test-result info" style="display: none;"></div>
    </div>

    <script>
        // å°å…¥æˆ‘å€‘ä¿®å¾©çš„ JSON å·¥å…·å‡½æ•¸
        function safeJSONStringify(obj) {
            try {
                return JSON.stringify(obj, (key, value) => {
                    if (typeof value === 'string') {
                        return value // ä¿æŒåŸæ¨£ï¼Œä¸é€²è¡Œé¡å¤–è½‰ç¾©
                    }
                    return value
                })
            } catch (error) {
                console.error('JSONåºåˆ—åŒ–å¤±æ•—:', error)
                throw new Error('æ•¸æ“šåºåˆ—åŒ–å¤±æ•—')
            }
        }

        function escapeSpecialChars(str) {
            if (typeof str !== 'string') return str
            
            return str
                .replace(/\\/g, '\\\\')  // åæ–œæ 
                .replace(/"/g, '\\"')    // é›™å¼•è™Ÿ
                .replace(/'/g, "\\'")    // å–®å¼•è™Ÿ
                .replace(/\n/g, '\\n')   // æ›è¡Œç¬¦
                .replace(/\r/g, '\\r')   // å›è»Šç¬¦
                .replace(/\t/g, '\\t')   // åˆ¶è¡¨ç¬¦
        }

        function createSafeLoginPayload(credentials) {
            const payload = {
                username: credentials.username.trim(),
                password: credentials.password, // å¯†ç¢¼ä¿æŒåŸæ¨£
                rememberMe: credentials.rememberMe || false
            }
            
            if (credentials.mfa_code) {
                payload.mfa_code = credentials.mfa_code.trim()
            }
            
            return payload
        }

        // æ¸¬è©¦å‡½æ•¸
        function testJSONEscape() {
            const password = document.getElementById('testPassword').value;
            const result = document.getElementById('jsonResult');
            result.style.display = 'block';
            
            try {
                // æ¸¬è©¦åŸå§‹JSON.stringify
                let originalJSON;
                try {
                    originalJSON = JSON.stringify({ password: password });
                    result.innerHTML += `<strong>âœ… åŸå§‹JSON.stringifyæˆåŠŸ:</strong><br>${originalJSON}<br><br>`;
                    result.className = 'test-result success';
                } catch (e) {
                    result.innerHTML += `<strong>âŒ åŸå§‹JSON.stringifyå¤±æ•—:</strong><br>${e.message}<br><br>`;
                    result.className = 'test-result error';
                }

                // æ¸¬è©¦å®‰å…¨ç‰ˆæœ¬
                const safeJSON = safeJSONStringify({ password: password });
                result.innerHTML += `<strong>âœ… å®‰å…¨JSONåºåˆ—åŒ–æˆåŠŸ:</strong><br>${safeJSON}<br><br>`;
                
                // æ¸¬è©¦å‰µå»ºç™»å…¥è² è¼‰
                const payload = createSafeLoginPayload({
                    username: 'admin',
                    password: password,
                    rememberMe: false
                });
                const payloadJSON = safeJSONStringify(payload);
                result.innerHTML += `<strong>âœ… ç™»å…¥è² è¼‰å‰µå»ºæˆåŠŸ:</strong><br>${payloadJSON}<br><br>`;
                
                if (result.className !== 'test-result error') {
                    result.className = 'test-result success';
                }
            } catch (error) {
                result.innerHTML += `<strong>âŒ æ¸¬è©¦å¤±æ•—:</strong><br>${error.message}`;
                result.className = 'test-result error';
            }
        }

        async function testAPIHealth() {
            const result = document.getElementById('healthResult');
            result.style.display = 'block';
            result.innerHTML = 'ğŸ” æª¢æŸ¥ API å¥åº·ç‹€æ…‹...<br>';
            
            // å®šç¾©å¤šå€‹APIç«¯é»é€²è¡Œæ¸¬è©¦
            const apiEndpoints = [
                { name: 'ç›´æ¥å¾Œç«¯é€£æ¥', url: 'http://localhost:8090/api/admin/auth/test' },
                { name: 'Nginxä»£ç†é€£æ¥', url: '/api/admin/auth/test' },
                { name: 'å‚™ç”¨å¥åº·æª¢æŸ¥', url: '/api/health' }
            ];
            
            for (const endpoint of apiEndpoints) {
                try {
                    result.innerHTML += `<br>ğŸ“¡ æ¸¬è©¦ ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        const data = await response.json();
                        result.innerHTML += `<strong>âœ… ${endpoint.name} æˆåŠŸ:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result success';
                        return; // æœ‰ä¸€å€‹æˆåŠŸå°±çµæŸ
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    result.innerHTML += `<strong>âŒ ${endpoint.name} å¤±æ•—:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>âš ï¸ æ‰€æœ‰APIç«¯é»éƒ½ç„¡æ³•é€£æ¥</strong><br>`;
        }

        async function testAdminDebug() {
            const result = document.getElementById('healthResult');
            result.style.display = 'block';
            result.innerHTML = 'ğŸ” èª¿è©¦ Admin ç”¨æˆ¶...<br>';
            
            // æ¸¬è©¦å¤šå€‹èª¿è©¦ç«¯é»
            const debugEndpoints = [
                { name: 'ç›´æ¥å¾Œç«¯èª¿è©¦', url: 'http://localhost:8090/api/admin/auth/debug/test-admin' },
                { name: 'Nginxä»£ç†èª¿è©¦', url: '/api/admin/auth/debug/test-admin' }
            ];
            
            for (const endpoint of debugEndpoints) {
                try {
                    result.innerHTML += `<br>ğŸ”§ æ¸¬è©¦ ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url);
                    if (response.ok) {
                        const data = await response.json();
                        result.innerHTML += `<strong>âœ… ${endpoint.name} æˆåŠŸ:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result success';
                        return;
                    } else {
                        result.innerHTML += `<strong>âŒ ${endpoint.name} HTTPéŒ¯èª¤:</strong> ${response.status}<br>`;
                    }
                } catch (error) {
                    result.innerHTML += `<strong>âŒ ${endpoint.name} é€£æ¥å¤±æ•—:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>âš ï¸ æ‰€æœ‰èª¿è©¦ç«¯é»éƒ½ç„¡æ³•é€£æ¥</strong><br>`;
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginResult');
            result.style.display = 'block';
            result.innerHTML = 'ğŸ” æ¸¬è©¦ç™»å…¥...<br>';
            
            // å‰µå»ºå®‰å…¨çš„ç™»å…¥è² è¼‰
            const payload = createSafeLoginPayload({
                username: username,
                password: password,
                rememberMe: false
            });
            
            result.innerHTML += `<strong>ğŸ“¦ ç™»å…¥è² è¼‰:</strong><br><pre>${safeJSONStringify(payload)}</pre><br>`;
            
            // æ¸¬è©¦å¤šå€‹ç™»å…¥ç«¯é»
            const loginEndpoints = [
                { name: 'ç›´æ¥å¾Œç«¯ç™»å…¥', url: 'http://localhost:8090/api/admin/auth/login' },
                { name: 'Nginxä»£ç†ç™»å…¥', url: '/api/admin/auth/login' }
            ];
            
            for (const endpoint of loginEndpoints) {
                try {
                    result.innerHTML += `<br>ğŸ” å˜—è©¦ ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: safeJSONStringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        result.innerHTML += `<strong>âœ… ${endpoint.name} æˆåŠŸ:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result success';
                        return;
                    } else {
                        result.innerHTML += `<strong>âŒ ${endpoint.name} å¤±æ•—:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                    }
                } catch (error) {
                    result.innerHTML += `<strong>âŒ ${endpoint.name} é€£æ¥å¤±æ•—:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>âš ï¸ æ‰€æœ‰ç™»å…¥ç«¯é»éƒ½ç„¡æ³•é€£æ¥</strong><br>`;
        }

        async function testDebugEndpoint() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginResult');
            result.style.display = 'block';
            result.innerHTML = 'ğŸ” é‹è¡Œç™»å…¥è¨ºæ–·...<br>';
            
            const payload = createSafeLoginPayload({
                username: username,
                password: password
            });
            
            // æ¸¬è©¦å¤šå€‹è¨ºæ–·ç«¯é»
            const diagnosisEndpoints = [
                { name: 'ç›´æ¥å¾Œç«¯è¨ºæ–·', url: 'http://localhost:8090/api/admin/auth/debug/login-diagnosis' },
                { name: 'Nginxä»£ç†è¨ºæ–·', url: '/api/admin/auth/debug/login-diagnosis' }
            ];
            
            for (const endpoint of diagnosisEndpoints) {
                try {
                    result.innerHTML += `<br>ğŸ” å˜—è©¦ ${endpoint.name}...<br>`;
                    const response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: safeJSONStringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        result.innerHTML += `<strong>ğŸ“Š ${endpoint.name} è¨ºæ–·çµæœ:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                        result.className = 'test-result info';
                        return;
                    } else {
                        result.innerHTML += `<strong>âŒ ${endpoint.name} è¨ºæ–·å¤±æ•—:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre><br>`;
                    }
                } catch (error) {
                    result.innerHTML += `<strong>âŒ ${endpoint.name} é€£æ¥å¤±æ•—:</strong><br>${error.message}<br>`;
                }
            }
            
            result.className = 'test-result error';
            result.innerHTML += `<strong>âš ï¸ æ‰€æœ‰è¨ºæ–·ç«¯é»éƒ½ç„¡æ³•é€£æ¥</strong><br>`;
        }

        // é é¢åŠ è¼‰æ™‚é¡¯ç¤ºåŸºæœ¬ä¿¡æ¯
        window.onload = function() {
            console.log('ğŸ”§ ç™»å…¥ä¿®å¾©æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ä¿®å¾©å…§å®¹:');
            console.log('1. âœ… æ•¸æ“šåº«adminå¯†ç¢¼æ›´æ–°ç‚ºAdmin123(ç„¡æ„Ÿå˜†è™Ÿ)');
            console.log('2. âœ… å‰ç«¯JSONè½‰ç¾©å•é¡Œä¿®å¾©');
            console.log('3. âœ… å¾Œç«¯éŒ¯èª¤è™•ç†å¢å¼·');
            console.log('4. âœ… èª¿è©¦æ¨¡å¼å’Œè¨ºæ–·ä¿¡æ¯æ·»åŠ ');
            console.log('è«‹ä½¿ç”¨ä¸Šè¿°æ¸¬è©¦åŠŸèƒ½é©—è­‰ä¿®å¾©æ•ˆæœ');
        }
    </script>
</body>
</html>