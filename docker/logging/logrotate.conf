# ============================================================================
# USDT Trading Platform Log Rotation Configuration
# ============================================================================
# This configuration manages log rotation for all platform services
# Logs are rotated daily with compression and retention for 30 days
# ============================================================================

# Global log rotation settings
daily
missingok
rotate 30
compress
delaycompress
notifempty
create
copytruncate
sharedscripts

# ============================================================================
# Application Logs
# ============================================================================

# Backend application logs
/app/logs/backend/*.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 appuser appuser
    copytruncate
    postrotate
        # Send USR1 signal to application for log file reopening if needed
        /usr/bin/docker exec usdt-backend pkill -USR1 java || true
    endscript
}

# Spring Boot application logs
/app/logs/backend/spring.log {
    daily
    rotate 30
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 appuser appuser
    copytruncate
}

# Application audit logs (keep longer)
/app/logs/backend/audit.log {
    daily
    rotate 90
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 appuser appuser
    copytruncate
}

# ============================================================================
# Database Logs
# ============================================================================

# MySQL error logs
/var/log/mysql/error.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 mysql mysql
    copytruncate
    postrotate
        /usr/bin/docker exec usdt-mysql mysqladmin flush-logs || true
    endscript
}

# MySQL slow query logs
/var/log/mysql/slow.log {
    daily
    rotate 14
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0640 mysql mysql
    copytruncate
    postrotate
        /usr/bin/docker exec usdt-mysql mysqladmin flush-logs || true
    endscript
}

# Redis logs
/var/log/redis/redis.log {
    daily
    rotate 14
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 redis redis
    copytruncate
}

# ============================================================================
# Web Server Logs
# ============================================================================

# Nginx access logs
/var/log/nginx/access.log {
    daily
    rotate 30
    size 100M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nginx nginx
    postrotate
        /usr/bin/docker exec usdt-nginx nginx -s reopen || true
    endscript
}

# Nginx error logs
/var/log/nginx/error.log {
    daily
    rotate 30
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nginx nginx
    postrotate
        /usr/bin/docker exec usdt-nginx nginx -s reopen || true
    endscript
}

# Frontend access logs
/var/log/nginx/admin-*.log /var/log/nginx/user-*.log {
    daily
    rotate 14
    size 50M
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nginx nginx
    sharedscripts
    postrotate
        /usr/bin/docker exec usdt-nginx nginx -s reopen || true
    endscript
}

# ============================================================================
# System and Docker Logs
# ============================================================================

# Docker container logs (managed by Docker daemon)
# Configure in /etc/docker/daemon.json:
# {
#   "log-driver": "json-file",
#   "log-opts": {
#     "max-size": "50m",
#     "max-file": "5"
#   }
# }

# Application temporary logs
/app/logs/*/temp.log {
    hourly
    rotate 24
    size 10M
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}