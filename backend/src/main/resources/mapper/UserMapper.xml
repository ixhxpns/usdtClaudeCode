<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.usdttrading.repository.UserMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.usdttrading.entity.User">
        <id column="id" property="id" />
        <result column="email" property="email" />
        <result column="phone" property="phone" />
        <result column="password_hash" property="passwordHash" />
        <result column="salt" property="salt" />
        <result column="google_auth_key" property="googleAuthKey" />
        <result column="status" property="status" />
        <result column="email_verified" property="emailVerified" />
        <result column="phone_verified" property="phoneVerified" />
        <result column="google_auth_enabled" property="googleAuthEnabled" />
        <result column="role_id" property="roleId" />
        <result column="last_login_at" property="lastLoginAt" />
        <result column="last_login_ip" property="lastLoginIp" />
        <result column="login_attempts" property="loginAttempts" />
        <result column="locked_until" property="lockedUntil" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
        <result column="role_name" property="roleName" />
    </resultMap>

    <!-- 更新登录信息 -->
    <update id="updateLoginInfo">
        UPDATE users 
        SET last_login_at = CURRENT_TIMESTAMP,
            last_login_ip = #{loginIp},
            login_attempts = 0,
            locked_until = NULL,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <!-- 重置登录尝试次数 -->
    <update id="resetLoginAttempts">
        UPDATE users 
        SET login_attempts = 0,
            locked_until = NULL,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <!-- 增加登录尝试次数 -->
    <update id="incrementLoginAttempts">
        UPDATE users 
        SET login_attempts = COALESCE(login_attempts, 0) + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <!-- 锁定账户 -->
    <update id="lockAccount">
        UPDATE users 
        SET locked_until = DATE_ADD(CURRENT_TIMESTAMP, INTERVAL #{lockMinutes} MINUTE),
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <!-- 解锁账户 -->
    <update id="unlockAccount">
        UPDATE users 
        SET login_attempts = 0,
            locked_until = NULL,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{userId}
    </update>

    <!-- 通用查询SQL片段 -->
    <sql id="selectUserWithRole">
        SELECT u.*, r.name as role_name 
        FROM users u 
        LEFT JOIN roles r ON u.role_id = r.id 
        WHERE u.deleted = 0
    </sql>

    <!-- 根据ID查询用户（包含角色信息） -->
    <select id="selectById" resultMap="BaseResultMap">
        <include refid="selectUserWithRole" />
        AND u.id = #{id}
    </select>

    <!-- 分页查询用户列表 -->
    <select id="selectUserList" resultMap="BaseResultMap">
        <include refid="selectUserWithRole" />
        <where>
            <if test="email != null and email != ''">
                AND u.email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="phone != null and phone != ''">
                AND u.phone LIKE CONCAT('%', #{phone}, '%')
            </if>
            <if test="status != null and status != ''">
                AND u.status = #{status}
            </if>
            <if test="roleId != null">
                AND u.role_id = #{roleId}
            </if>
        </where>
        ORDER BY u.created_at DESC
    </select>

</mapper>