<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.usdttrading.repository.KycReviewMapper">
    
    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.usdttrading.entity.KycReview">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="kyc_id" property="kycId" jdbcType="BIGINT"/>
        <result column="reviewer_id" property="reviewerId" jdbcType="BIGINT"/>
        <result column="status" property="status" jdbcType="VARCHAR"/>
        <result column="decision" property="decision" jdbcType="VARCHAR"/>
        <result column="review_note" property="reviewNote" jdbcType="LONGVARCHAR"/>
        <result column="rejection_reason" property="rejectionReason" jdbcType="LONGVARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
        <result column="deleted" property="deleted" jdbcType="INTEGER"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 基础列列表 -->
    <sql id="Base_Column_List">
        id, kyc_id, reviewer_id, status, decision, review_note, rejection_reason,
        created_at, updated_at, deleted, version
    </sql>

    <!-- 根据KYC ID和审核状态查询 -->
    <select id="selectByKycIdAndStatus" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM kyc_reviews 
        WHERE kyc_id = #{kycId} AND status = #{status}
        AND deleted = 0
        ORDER BY created_at DESC
    </select>

    <!-- 查询待分配的审核任务 -->
    <select id="selectPendingAssignment" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM kyc_reviews 
        WHERE status = 'pending' AND reviewer_id IS NULL
        AND deleted = 0
        ORDER BY created_at ASC
        LIMIT #{limit}
    </select>

    <!-- 根据审核人统计审核数量 -->
    <select id="countByReviewerAndTimeRange" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM kyc_reviews
        WHERE reviewer_id = #{reviewerId}
        AND created_at BETWEEN #{startTime} AND #{endTime}
        AND deleted = 0
    </select>

</mapper>