<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.usdttrading.repository.AuditLogMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.usdttrading.entity.AuditLog">
        <id column="id" property="id" />
        <result column="user_id" property="userId" />
        <result column="action" property="action" />
        <result column="resource" property="resource" />
        <result column="resource_id" property="resourceId" />
        <result column="description" property="description" />
        <result column="old_values" property="oldValues" />
        <result column="new_values" property="newValues" />
        <result column="ip_address" property="ipAddress" />
        <result column="user_agent" property="userAgent" />
        <result column="request_id" property="requestId" />
        <result column="session_id" property="sessionId" />
        <result column="result" property="result" />
        <result column="error_message" property="errorMessage" />
        <result column="execution_time" property="executionTime" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
        <result column="deleted" property="deleted" />
        <result column="user_email" property="userEmail" />
    </resultMap>

    <!-- 通用查询SQL片段 -->
    <sql id="selectAuditLogWithUser">
        SELECT al.*, u.email as user_email 
        FROM audit_logs al 
        LEFT JOIN users u ON al.user_id = u.id 
        WHERE al.deleted = 0
    </sql>

    <!-- 查询条件SQL片段 -->
    <sql id="whereConditions">
        <where>
            <if test="userId != null">
                AND al.user_id = #{userId}
            </if>
            <if test="action != null and action != ''">
                AND al.action = #{action}
            </if>
            <if test="resource != null and resource != ''">
                AND al.resource = #{resource}
            </if>
            <if test="resourceId != null and resourceId != ''">
                AND al.resource_id = #{resourceId}
            </if>
            <if test="ipAddress != null and ipAddress != ''">
                AND al.ip_address = #{ipAddress}
            </if>
            <if test="result != null and result != ''">
                AND al.result = #{result}
            </if>
            <if test="startTime != null">
                AND al.created_at >= #{startTime}
            </if>
            <if test="endTime != null">
                AND al.created_at &lt;= #{endTime}
            </if>
            <if test="minExecutionTime != null">
                AND al.execution_time >= #{minExecutionTime}
            </if>
            <if test="maxExecutionTime != null">
                AND al.execution_time &lt;= #{maxExecutionTime}
            </if>
        </where>
    </sql>

    <!-- 根据ID查询审计日志（包含用户信息） -->
    <select id="selectById" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.id = #{id}
    </select>

    <!-- 分页查询审计日志列表 -->
    <select id="selectAuditLogList" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        <include refid="whereConditions" />
        ORDER BY al.created_at DESC
    </select>

    <!-- 分页查询用户操作日志 -->
    <select id="selectPageByUserId" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.user_id = #{userId}
        ORDER BY al.created_at DESC
    </select>

    <!-- 分页查询操作日志 -->
    <select id="selectPageByAction" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.action = #{action}
        ORDER BY al.created_at DESC
    </select>

    <!-- 查询指定资源的操作记录 -->
    <select id="selectByResource" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.resource = #{resource} 
        AND al.resource_id = #{resourceId}
        ORDER BY al.created_at DESC
    </select>

    <!-- 查询指定IP的操作记录 -->
    <select id="selectByIpAddress" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.ip_address = #{ipAddress}
        ORDER BY al.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 查询失败的操作记录 -->
    <select id="selectFailedOperations" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.result IN ('failure', 'error') 
        AND al.created_at BETWEEN #{startTime} AND #{endTime}
        ORDER BY al.created_at DESC
    </select>

    <!-- 统计操作次数 -->
    <select id="countUserActions" resultType="java.lang.Long">
        SELECT COUNT(*) 
        FROM audit_logs 
        WHERE user_id = #{userId} 
        AND action = #{action} 
        AND created_at >= #{since}
        AND deleted = 0
    </select>

    <!-- 查询慢操作记录 -->
    <select id="selectSlowOperations" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.execution_time &gt; #{threshold} 
        AND al.created_at BETWEEN #{startTime} AND #{endTime}
        ORDER BY al.execution_time DESC
    </select>

    <!-- 查询用户最近的操作记录 -->
    <select id="selectRecentUserActions" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.user_id = #{userId}
        ORDER BY al.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 查询敏感操作记录 -->
    <select id="selectSensitiveOperations" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.action IN ('delete', 'withdraw', 'transfer', 'admin_login', 'role_change', 'permission_grant')
        <if test="startTime != null">
            AND al.created_at >= #{startTime}
        </if>
        <if test="endTime != null">
            AND al.created_at &lt;= #{endTime}
        </if>
        ORDER BY al.created_at DESC
    </select>

    <!-- 查询系统操作记录 -->
    <select id="selectSystemOperations" resultMap="BaseResultMap">
        <include refid="selectAuditLogWithUser" />
        AND al.user_id IS NULL
        <if test="startTime != null">
            AND al.created_at >= #{startTime}
        </if>
        <if test="endTime != null">
            AND al.created_at &lt;= #{endTime}
        </if>
        ORDER BY al.created_at DESC
    </select>

    <!-- 统计按操作类型分组的记录数 -->
    <select id="countByAction" resultType="java.util.Map">
        SELECT al.action, COUNT(*) as count
        FROM audit_logs al 
        WHERE al.deleted = 0
        <if test="startTime != null">
            AND al.created_at >= #{startTime}
        </if>
        <if test="endTime != null">
            AND al.created_at &lt;= #{endTime}
        </if>
        GROUP BY al.action
        ORDER BY count DESC
    </select>

    <!-- 统计按结果分组的记录数 -->
    <select id="countByResult" resultType="java.util.Map">
        SELECT al.result, COUNT(*) as count
        FROM audit_logs al 
        WHERE al.deleted = 0
        <if test="startTime != null">
            AND al.created_at >= #{startTime}
        </if>
        <if test="endTime != null">
            AND al.created_at &lt;= #{endTime}
        </if>
        GROUP BY al.result
        ORDER BY count DESC
    </select>

    <!-- 统计每日操作量 -->
    <select id="countByDate" resultType="java.util.Map">
        SELECT DATE(al.created_at) as date, COUNT(*) as count
        FROM audit_logs al 
        WHERE al.deleted = 0
        AND al.created_at BETWEEN #{startTime} AND #{endTime}
        GROUP BY DATE(al.created_at)
        ORDER BY date DESC
    </select>

    <!-- 统计每小时操作量 -->
    <select id="countByHour" resultType="java.util.Map">
        SELECT HOUR(al.created_at) as hour, COUNT(*) as count
        FROM audit_logs al 
        WHERE al.deleted = 0
        AND DATE(al.created_at) = #{date}
        GROUP BY HOUR(al.created_at)
        ORDER BY hour ASC
    </select>

    <!-- 查询异常IP地址 -->
    <select id="selectAbnormalIpAddresses" resultType="java.util.Map">
        SELECT al.ip_address, COUNT(*) as count, 
               COUNT(CASE WHEN al.result = 'failure' THEN 1 END) as failure_count
        FROM audit_logs al 
        WHERE al.deleted = 0
        AND al.created_at >= #{since}
        GROUP BY al.ip_address
        HAVING count >= #{minCount} OR failure_count >= #{minFailureCount}
        ORDER BY failure_count DESC, count DESC
    </select>

    <!-- 查询用户操作统计 -->
    <select id="selectUserActionStats" resultType="java.util.Map">
        SELECT u.email, al.action, COUNT(*) as count,
               AVG(al.execution_time) as avg_execution_time,
               MAX(al.execution_time) as max_execution_time
        FROM audit_logs al
        JOIN users u ON al.user_id = u.id
        WHERE al.deleted = 0
        AND al.created_at BETWEEN #{startTime} AND #{endTime}
        GROUP BY u.email, al.action
        ORDER BY count DESC
    </select>

    <!-- 清理过期的审计日志 -->
    <delete id="deleteExpiredLogs">
        DELETE FROM audit_logs 
        WHERE created_at &lt; #{expiredDate}
        AND deleted = 0
    </delete>

    <!-- 软删除过期的审计日志 -->
    <update id="softDeleteExpiredLogs">
        UPDATE audit_logs 
        SET deleted = 1, updated_at = NOW()
        WHERE created_at &lt; #{expiredDate}
        AND deleted = 0
    </update>

    <!-- 批量插入审计日志 -->
    <insert id="batchInsert">
        INSERT INTO audit_logs (
            user_id, action, resource, resource_id, description, 
            old_values, new_values, ip_address, user_agent, 
            request_id, session_id, result, error_message, 
            execution_time, created_at, updated_at
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.userId}, #{item.action}, #{item.resource}, #{item.resourceId}, #{item.description},
                #{item.oldValues}, #{item.newValues}, #{item.ipAddress}, #{item.userAgent},
                #{item.requestId}, #{item.sessionId}, #{item.result}, #{item.errorMessage},
                #{item.executionTime}, NOW(), NOW()
            )
        </foreach>
    </insert>

</mapper>