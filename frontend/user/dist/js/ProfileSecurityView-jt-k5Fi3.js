var c=(X,_,y)=>new Promise((F,V)=>{var z=f=>{try{A(y.next(f))}catch(U){V(U)}},I=f=>{try{A(y.throw(f))}catch(U){V(U)}},A=f=>f.done?F(f.value):Promise.resolve(f.value).then(z,I);A((y=y.apply(X,_)).next())});import{h as Ee,m as Fe,S as Ae,j as Ue,t as Me,w as ze,a2 as Ie,l as Ne,x as qe,a3 as De,a4 as He,a5 as $e,a6 as Le,c as Be,f as Te,g as Re,v as Ye,a7 as je,a8 as Ge,p as Qe,a9 as Ze,E as H}from"./element-plus-BimyLctg.js";import{u as Je,A as T,_ as Ke}from"./index-CNq4hTTw.js";import{P as Oe}from"./PasswordStrengthMeter-D5d-th8Y.js";import{V as O}from"./VerificationCodeInput-C7bNLV10.js";import{aN as We}from"./vendor-CPjYCZhe.js";import{d as Xe,r as i,c as ve,o as el,f as w,j as r,Q as l,H as s,k as t,J as W,u as E,O as P,G as $,M as d,I as ll,K as tl}from"./vue-vendor-D1tpuXMX.js";const sl={class:"security-view"},al={class:"card-header"},ol={class:"security-items"},il={class:"security-item"},nl={class:"item-info"},dl={class:"item-content"},ul={class:"item-desc"},rl={class:"item-action"},vl={class:"security-item"},ml={class:"item-info"},cl={class:"item-content"},fl={class:"item-desc"},pl={class:"item-action"},_l={class:"security-item"},gl={class:"item-info"},wl={class:"item-content"},yl={class:"item-desc"},Vl={class:"item-action"},bl={class:"security-item"},hl={class:"item-info"},Pl={class:"item-action"},kl={key:0,class:"pagination"},Cl={class:"phone-verification"},Sl={key:0,class:"phone-step"},xl={key:1,class:"phone-step"},El={class:"code-input"},Fl={class:"resend-area"},Al={class:"mfa-setup"},Ul={key:0,class:"mfa-enable"},Ml={class:"step-indicator"},zl={class:"mfa-content"},Il={key:0,class:"qr-step"},Nl={class:"qr-code"},ql=["src"],Dl={key:1,class:"verify-step"},Hl={key:2,class:"success-step"},$l={class:"success-icon"},Ll={key:1,class:"mfa-disable"},Bl={class:"disable-warning"},Tl=Xe({__name:"ProfileSecurityView",setup(X){const _=Je(),y=i(!1),F=i(!1),V=i(!1),z=i(!1),I=i([]),A=i(1),f=i(10),U=i(0),N=i(!1),R=i(!1),Y=i(),m=i({currentPassword:"",newPassword:"",confirmPassword:""}),q=i(!1),j=i(1),G=i(!1),M=i(0),b=i({phone:"",code:""}),k=i(!1),C=i(0),ee=i(""),h=i({code:""}),S=i({loginNotifications:!1,twoStepVerification:!1}),n=ve(()=>_.user),le=ve(()=>{var e,u,g;let o=0;return(e=n.value)!=null&&e.email_verified&&o++,(u=n.value)!=null&&u.phone_verified&&o++,(g=n.value)!=null&&g.mfa_enabled&&o++,o===3?{type:"success",text:"安全等級：高"}:o===2?{type:"warning",text:"安全等級：中"}:{type:"danger",text:"安全等級：低"}}),me={currentPassword:[{required:!0,message:"請輸入當前密碼",trigger:"blur"}],newPassword:[{required:!0,message:"請輸入新密碼",trigger:"blur"},{min:8,message:"密碼長度至少8位",trigger:"blur"},{pattern:/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/,message:"密碼必須包含大小寫字母、數字和特殊字符",trigger:"blur"}],confirmPassword:[{required:!0,message:"請確認新密碼",trigger:"blur"},{validator:(o,e,u)=>{e!==m.value.newPassword?u(new Error("兩次輸入的密碼不一致")):u()},trigger:"blur"}]},ce=()=>c(this,null,function*(){try{y.value=!0,yield _.sendEmailVerification()}finally{y.value=!1}}),fe=()=>{var o,e;b.value.phone=((o=n.value)==null?void 0:o.phone)||"",j.value=(e=n.value)!=null&&e.phone?2:1,q.value=!0},te=()=>c(this,null,function*(){try{G.value=!0,yield _.sendPhoneCode(),j.value=2,_e()}finally{G.value=!1}}),pe=()=>c(this,null,function*(){try{yield _.verifyPhone(b.value.code),q.value=!1,b.value.code=""}catch(o){}}),_e=()=>{M.value=60;const o=setInterval(()=>{M.value--,M.value<=0&&clearInterval(o)},1e3)},ge=o=>c(this,null,function*(){var e;if(o!==((e=n.value)==null?void 0:e.mfa_enabled))if(o)try{const u=yield T.getMFASetup();ee.value=u.qr_code_url,C.value=0,k.value=!0}catch(u){H.error(u.message||"獲取MFA設置信息失敗"),F.value=!1}else k.value=!0}),we=()=>c(this,null,function*(){try{V.value=!0,yield _.toggleMFA(!0,h.value.code),C.value=2,setTimeout(()=>{k.value=!1,C.value=0,h.value.code=""},2e3)}finally{V.value=!1}}),ye=()=>c(this,null,function*(){try{V.value=!0,yield _.toggleMFA(!1,h.value.code),k.value=!1,h.value.code=""}finally{V.value=!1}}),Ve=()=>{N.value=!0},be=()=>c(this,null,function*(){if(Y.value)try{if(!(yield Y.value.validate()))return;R.value=!0,yield _.changePassword(m.value),N.value=!1,m.value={currentPassword:"",newPassword:"",confirmPassword:""}}finally{R.value=!1}}),se=()=>c(this,null,function*(){try{yield T.updateSecuritySettings(S.value),H.success("安全設置已更新")}catch(o){H.error(o.message||"更新安全設置失敗")}}),ae=(o=1)=>c(this,null,function*(){try{z.value=!0;const e=yield T.getLoginHistory(o,f.value);I.value=e.data,U.value=e.pagination.total_items}catch(e){H.error(e.message||"載入登錄記錄失敗")}finally{z.value=!1}}),he=()=>c(this,null,function*(){try{const o=yield T.getSecuritySettings();S.value={loginNotifications:o.login_notifications,twoStepVerification:o.two_step_verification}}catch(o){H.error(o.message||"載入安全設置失敗")}});return el(()=>{var o;F.value=((o=n.value)==null?void 0:o.mfa_enabled)||!1,ae(),he()}),(o,e)=>{const u=Ae,g=Ee,p=Ue,Q=Ie,Z=qe,D=He,Pe=De,ke=Le,x=Te,L=Be,B=Re,J=Ye,K=Ge,Ce=je,Se=$e;return r(),w("div",sl,[l(Z,{class:"security-overview",shadow:"never"},{header:s(()=>[t("div",al,[e[18]||(e[18]=t("h3",null,"安全概覽",-1)),l(u,{type:le.value.type,size:"large"},{default:s(()=>[d(P(le.value.text),1)]),_:1},8,["type"])])]),default:s(()=>{var a,v,oe,ie,ne,de,ue,re;return[t("div",ol,[t("div",il,[t("div",nl,[l(g,{class:W(["item-icon",{verified:(a=n.value)==null?void 0:a.email_verified}])},{default:s(()=>[l(E(Fe))]),_:1},8,["class"]),t("div",dl,[e[19]||(e[19]=t("div",{class:"item-title"},"郵箱驗證",-1)),t("div",ul,P(((v=n.value)==null?void 0:v.email)||"未設置"),1)])]),t("div",rl,[(oe=n.value)!=null&&oe.email_verified?(r(),$(u,{key:0,type:"success"},{default:s(()=>[...e[20]||(e[20]=[d("已驗證",-1)])]),_:1})):(r(),$(p,{key:1,type:"warning",size:"small",onClick:ce,loading:y.value},{default:s(()=>[...e[21]||(e[21]=[d(" 立即驗證 ",-1)])]),_:1},8,["loading"]))])]),t("div",vl,[t("div",ml,[l(g,{class:W(["item-icon",{verified:(ie=n.value)==null?void 0:ie.phone_verified}])},{default:s(()=>[l(E(Me))]),_:1},8,["class"]),t("div",cl,[e[22]||(e[22]=t("div",{class:"item-title"},"手機驗證",-1)),t("div",fl,P(((ne=n.value)==null?void 0:ne.phone)||"未設置"),1)])]),t("div",pl,[(de=n.value)!=null&&de.phone_verified?(r(),$(u,{key:0,type:"success"},{default:s(()=>[...e[23]||(e[23]=[d("已驗證",-1)])]),_:1})):(r(),$(p,{key:1,type:"warning",size:"small",onClick:fe},{default:s(()=>[...e[24]||(e[24]=[d(" 立即驗證 ",-1)])]),_:1}))])]),t("div",_l,[t("div",gl,[l(g,{class:W(["item-icon",{verified:(ue=n.value)==null?void 0:ue.mfa_enabled}])},{default:s(()=>[l(E(ze))]),_:1},8,["class"]),t("div",wl,[e[25]||(e[25]=t("div",{class:"item-title"},"雙因子認證 (2FA)",-1)),t("div",yl,P((re=n.value)!=null&&re.mfa_enabled?"已啟用":"未啟用"),1)])]),t("div",Vl,[l(Q,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=xe=>F.value=xe),onChange:ge,loading:V.value},null,8,["modelValue","loading"])])]),t("div",bl,[t("div",hl,[l(g,{class:"item-icon verified"},{default:s(()=>[l(E(Ne))]),_:1}),e[26]||(e[26]=t("div",{class:"item-content"},[t("div",{class:"item-title"},"登錄密碼"),t("div",{class:"item-desc"},"定期更換密碼可提高安全性")],-1))]),t("div",Pl,[l(p,{size:"small",onClick:Ve},{default:s(()=>[...e[27]||(e[27]=[d(" 修改密碼 ",-1)])]),_:1})])])])]}),_:1}),l(Z,{class:"login-history",shadow:"never"},{header:s(()=>[...e[28]||(e[28]=[t("h3",null,"最近登錄記錄",-1)])]),default:s(()=>[ll((r(),$(Pe,{data:I.value,"empty-text":"暂无登录记录"},{default:s(()=>[l(D,{label:"登錄時間","min-width":"180"},{default:s(({row:a})=>[d(P(E(We)(a.login_time).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1}),l(D,{label:"IP地址",prop:"ip_address","min-width":"120"}),l(D,{label:"地理位置",prop:"location","min-width":"120"}),l(D,{label:"設備信息","min-width":"200"},{default:s(({row:a})=>{var v;return[d(P(((v=a.device_info)==null?void 0:v.device)||"未知設備"),1)]}),_:1}),l(D,{label:"登錄狀態",width:"100",align:"center"},{default:s(({row:a})=>[l(u,{type:a.status==="success"?"success":"danger",size:"small"},{default:s(()=>[d(P(a.status==="success"?"成功":"失敗"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])),[[Se,z.value]]),I.value.length>0?(r(),w("div",kl,[l(ke,{"current-page":A.value,"onUpdate:currentPage":e[1]||(e[1]=a=>A.value=a),"page-size":f.value,total:U.value,layout:"prev, pager, next, total",onCurrentChange:ae},null,8,["current-page","page-size","total"])])):tl("",!0)]),_:1}),l(Z,{class:"security-settings",shadow:"never"},{header:s(()=>[...e[29]||(e[29]=[t("h3",null,"安全設置",-1)])]),default:s(()=>[l(L,{model:S.value,"label-width":"140px"},{default:s(()=>[l(x,{label:"登錄通知"},{default:s(()=>[l(Q,{modelValue:S.value.loginNotifications,"onUpdate:modelValue":e[2]||(e[2]=a=>S.value.loginNotifications=a),onChange:se,"active-text":"開啟","inactive-text":"關閉"},null,8,["modelValue"]),e[30]||(e[30]=t("div",{class:"form-tip"}," 開啟後，每次登錄都會發送郵件通知 ",-1))]),_:1}),l(x,{label:"二次驗證"},{default:s(()=>[l(Q,{modelValue:S.value.twoStepVerification,"onUpdate:modelValue":e[3]||(e[3]=a=>S.value.twoStepVerification=a),onChange:se,"active-text":"開啟","inactive-text":"關閉"},null,8,["modelValue"]),e[31]||(e[31]=t("div",{class:"form-tip"}," 重要操作需要額外的驗證步驟 ",-1))]),_:1})]),_:1},8,["model"])]),_:1}),l(J,{modelValue:N.value,"onUpdate:modelValue":e[8]||(e[8]=a=>N.value=a),title:"修改密碼",width:"500px","close-on-click-modal":!1},{footer:s(()=>[l(p,{onClick:e[7]||(e[7]=a=>N.value=!1)},{default:s(()=>[...e[32]||(e[32]=[d("取消",-1)])]),_:1}),l(p,{type:"primary",onClick:be,loading:R.value},{default:s(()=>[...e[33]||(e[33]=[d(" 確認修改 ",-1)])]),_:1},8,["loading"])]),default:s(()=>[l(L,{ref_key:"passwordFormRef",ref:Y,model:m.value,rules:me,"label-width":"100px"},{default:s(()=>[l(x,{label:"當前密碼",prop:"currentPassword"},{default:s(()=>[l(B,{modelValue:m.value.currentPassword,"onUpdate:modelValue":e[4]||(e[4]=a=>m.value.currentPassword=a),type:"password",placeholder:"請輸入當前密碼","show-password":""},null,8,["modelValue"])]),_:1}),l(x,{label:"新密碼",prop:"newPassword"},{default:s(()=>[l(B,{modelValue:m.value.newPassword,"onUpdate:modelValue":e[5]||(e[5]=a=>m.value.newPassword=a),type:"password",placeholder:"請輸入新密碼","show-password":""},null,8,["modelValue"]),l(Oe,{password:m.value.newPassword},null,8,["password"])]),_:1}),l(x,{label:"確認密碼",prop:"confirmPassword"},{default:s(()=>[l(B,{modelValue:m.value.confirmPassword,"onUpdate:modelValue":e[6]||(e[6]=a=>m.value.confirmPassword=a),type:"password",placeholder:"請再次輸入新密碼","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(J,{modelValue:q.value,"onUpdate:modelValue":e[12]||(e[12]=a=>q.value=a),title:"手機驗證",width:"400px","close-on-click-modal":!1},{footer:s(()=>[l(p,{onClick:e[11]||(e[11]=a=>q.value=!1)},{default:s(()=>[...e[36]||(e[36]=[d("取消",-1)])]),_:1})]),default:s(()=>[t("div",Cl,[j.value===1?(r(),w("div",Sl,[l(L,{model:b.value,"label-width":"80px"},{default:s(()=>[l(x,{label:"手機號"},{default:s(()=>{var a;return[l(B,{modelValue:b.value.phone,"onUpdate:modelValue":e[9]||(e[9]=v=>b.value.phone=v),placeholder:"請輸入手機號碼",disabled:!!((a=n.value)!=null&&a.phone)},null,8,["modelValue","disabled"])]}),_:1})]),_:1},8,["model"]),l(p,{type:"primary",onClick:te,loading:G.value,block:""},{default:s(()=>[...e[34]||(e[34]=[d(" 發送驗證碼 ",-1)])]),_:1},8,["loading"])])):(r(),w("div",xl,[t("div",El,[l(O,{modelValue:b.value.code,"onUpdate:modelValue":e[10]||(e[10]=a=>b.value.code=a),length:6,onComplete:pe},null,8,["modelValue"])]),t("div",Fl,[e[35]||(e[35]=t("span",null,"沒收到驗證碼？",-1)),l(p,{type:"text",onClick:te,disabled:M.value>0},{default:s(()=>[d(P(M.value>0?`${M.value}s後重發`:"重新發送"),1)]),_:1},8,["disabled"])])]))])]),_:1},8,["modelValue"]),l(J,{modelValue:k.value,"onUpdate:modelValue":e[17]||(e[17]=a=>k.value=a),title:"雙因子認證設置",width:"500px","close-on-click-modal":!1},{footer:s(()=>[l(p,{onClick:e[16]||(e[16]=a=>k.value=!1)},{default:s(()=>[...e[44]||(e[44]=[d("取消",-1)])]),_:1})]),default:s(()=>{var a;return[t("div",Al,[(a=n.value)!=null&&a.mfa_enabled?(r(),w("div",Ll,[t("div",Bl,[l(g,null,{default:s(()=>[l(E(Ze))]),_:1}),e[42]||(e[42]=t("h3",null,"關閉雙因子認證",-1)),e[43]||(e[43]=t("p",null,"關閉雙因子認證會降低您賬戶的安全性，請謹慎操作。",-1))]),l(L,{"label-width":"100px"},{default:s(()=>[l(x,{label:"驗證碼"},{default:s(()=>[l(O,{modelValue:h.value.code,"onUpdate:modelValue":e[15]||(e[15]=v=>h.value.code=v),length:6,onComplete:ye},null,8,["modelValue"])]),_:1})]),_:1})])):(r(),w("div",Ul,[t("div",Ml,[l(Ce,{active:C.value,simple:""},{default:s(()=>[l(K,{title:"掃描二維碼"}),l(K,{title:"輸入驗證碼"}),l(K,{title:"完成設置"})]),_:1},8,["active"])]),t("div",zl,[C.value===0?(r(),w("div",Il,[t("div",Nl,[t("img",{src:ee.value,alt:"QR Code"},null,8,ql)]),e[38]||(e[38]=t("div",{class:"qr-instructions"},[t("p",null,"1. 下載並安裝驗證應用（如Google Authenticator）"),t("p",null,"2. 打開應用並掃描上方二維碼"),t("p",null,"3. 點擊下一步繼續")],-1)),l(p,{type:"primary",onClick:e[13]||(e[13]=v=>C.value=1),block:""},{default:s(()=>[...e[37]||(e[37]=[d(" 下一步 ",-1)])]),_:1})])):C.value===1?(r(),w("div",Dl,[e[39]||(e[39]=t("div",{class:"verify-instructions"},[t("p",null,"請輸入驗證應用中顯示的6位數驗證碼：")],-1)),l(O,{modelValue:h.value.code,"onUpdate:modelValue":e[14]||(e[14]=v=>h.value.code=v),length:6,onComplete:we},null,8,["modelValue"])])):(r(),w("div",Hl,[t("div",$l,[l(g,null,{default:s(()=>[l(E(Qe))]),_:1})]),e[40]||(e[40]=t("h3",null,"雙因子認證已啟用！",-1)),e[41]||(e[41]=t("p",null,"您的賬戶安全性已得到進一步提升。",-1))]))])]))])]}),_:1},8,["modelValue"])])}}}),Kl=Ke(Tl,[["__scopeId","data-v-db8153ae"]]);export{Kl as default};
