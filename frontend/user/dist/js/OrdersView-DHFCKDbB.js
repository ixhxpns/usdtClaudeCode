var w=(p,e,m)=>new Promise((n,h)=>{var _=c=>{try{u(m.next(c))}catch(y){h(y)}},b=c=>{try{u(m.throw(c))}catch(y){h(y)}},u=c=>c.done?n(c.value):Promise.resolve(c.value).then(_,b);u((m=m.apply(p,e)).next())});import{an as it,f as i,j as r,k as t,K as C,M as T,O as s,P as L,aj as F,J as S,I as U,aT as A,aS as I,aA as E,Y as O,Q as rt,H as dt,aQ as ct,r as f,_ as R,c as mt,o as ut}from"./vue-vendor-D1tpuXMX.js";import{_ as vt,b as B}from"./index-CNq4hTTw.js";import"./vendor-CPjYCZhe.js";import"./element-plus-BimyLctg.js";const ft={name:"OrdersView",setup(){const p=ct(),e=f(!1),m=f([]),n=f(0),h=f(0),_=f(!1),b=f(!1),u=f(null),c=f(!1),y=f(!1),P=f(""),k=f(""),g=f(null),o=R({type:"ALL",status:"",startDate:"",endDate:""}),d=R({current:1,pageSize:20,total:0,pages:0}),Y=mt(()=>{const a=Math.max(1,d.current-2),l=Math.min(d.pages,d.current+2),v=[];for(let M=a;M<=l;M++)v.push(M);return v}),N=[{label:"全部",value:"ALL",count:0},{label:"買入",value:"BUY",count:0},{label:"賣出",value:"SELL",count:0}],V=a=>new Intl.NumberFormat("zh-TW",{style:"currency",currency:"TWD",minimumFractionDigits:0}).format(a||0),x=a=>parseFloat(a||0).toFixed(6),z=a=>new Date(a).toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),G=a=>({PENDING:"待處理",PROCESSING:"處理中",COMPLETED:"已完成",CANCELLED:"已取消",FAILED:"失敗"})[a]||a,W=a=>({bank_transfer:"銀行轉帳",convenience_store:"超商付款",online_payment:"線上支付"})[a]||a,j=a=>["PENDING","PROCESSING"].includes(a.status),q=a=>a.status==="PENDING"&&a.orderType==="BUY",J=(a,l)=>{o[a]=l,d.current=1,D()},Q=a=>{d.current=a,D()},H=a=>{p.push(`/orders/${a}`)},K=a=>{u.value=a,P.value="",k.value="",_.value=!0},X=a=>{u.value=a,g.value=null,b.value=!0},Z=()=>{const a=document.querySelector('input[ref="paymentProofInput"]');a&&a.click()},$=a=>{const l=a.target.files[0];if(!l||!et(l))return;const v=new FileReader;v.onload=M=>{g.value={file:l,preview:M.target.result}},v.readAsDataURL(l)},tt=()=>{g.value=null;const a=document.querySelector('input[ref="paymentProofInput"]');a&&(a.value="")},et=a=>a.type.startsWith("image/")?a.size>5*1024*1024?(alert("文件大小不能超過5MB"),!1):!0:(alert("請選擇圖片文件"),!1),D=()=>w(this,null,function*(){e.value=!0;try{const a={pageNum:d.current,pageSize:d.pageSize};o.type!=="ALL"&&(a.orderType=o.type),o.status&&(a.status=o.status),o.startDate&&(a.startDate=o.startDate),o.endDate&&(a.endDate=o.endDate);const l=yield B.get("/orders/my",{params:a});if(l.data.success){const v=l.data.data;m.value=v.records,d.total=v.total,d.pages=v.pages}}catch(a){console.error("載入訂單失敗:",a)}finally{e.value=!1}}),nt=()=>{D()},ot=()=>w(this,null,function*(){if(P.value){c.value=!0;try{const a=P.value==="other"?k.value:st(P.value),l=yield B.post(`/trading/${u.value.id}/cancel`,{reason:a});l.data.success?(_.value=!1,D(),alert("訂單已取消")):alert("取消失敗: "+l.data.message)}catch(a){console.error("取消訂單失敗:",a),alert("取消失敗，請稍後重試")}finally{c.value=!1}}}),at=()=>w(this,null,function*(){if(g.value){y.value=!0;try{const a={screenshot:g.value.file.name,uploadTime:new Date().toISOString()},l=yield B.post(`/trading/${u.value.id}/confirm-payment`,{paymentProof:a});l.data.success?(b.value=!1,D(),alert("支付確認成功，請等待審核")):alert("確認失敗: "+l.data.message)}catch(a){console.error("確認支付失敗:",a),alert("確認失敗，請稍後重試")}finally{y.value=!1}}}),st=a=>({price_change:"價格變動",payment_issue:"支付問題",change_mind:"改變主意",other:"其他原因"})[a]||a,lt=()=>w(this,null,function*(){try{n.value=m.value.length,h.value=m.value.filter(a=>{const l=new Date(a.createdAt),v=new Date;return l.getMonth()===v.getMonth()&&l.getFullYear()===v.getFullYear()}).length,N[0].count=m.value.length,N[1].count=m.value.filter(a=>a.orderType==="BUY").length,N[2].count=m.value.filter(a=>a.orderType==="SELL").length}catch(a){console.error("載入統計數據失敗:",a)}});return ut(()=>{D().then(()=>{lt()})}),{loading:e,orders:m,totalOrders:n,monthlyOrders:h,showCancelOrderModal:_,showPaymentConfirmModal:b,selectedOrder:u,cancelling:c,confirming:y,cancelReason:P,cancelReasonDetail:k,paymentProof:g,activeFilter:o,pagination:d,visiblePages:Y,filterTabs:N,formatPrice:V,formatCrypto:x,formatDateTime:z,getStatusText:G,getPaymentMethodText:W,canCancelOrder:j,canConfirmPayment:q,setActiveFilter:J,changePage:Q,viewOrderDetail:H,showCancelModal:K,showPaymentModal:X,triggerPaymentProofUpload:Z,handlePaymentProofUpload:$,removePaymentProof:tt,refreshOrders:nt,confirmCancelOrder:ot,confirmPayment:at}}},pt={class:"orders-view"},yt={class:"filter-section"},gt={class:"filter-card"},Ct={class:"filter-header"},Pt={class:"filter-stats"},bt={class:"stats-item"},ht={class:"stats-item"},_t={class:"filter-controls"},kt={class:"filter-tabs"},Dt=["onClick"],Ot={key:0,class:"tab-count"},Mt={class:"filter-options"},wt=["disabled"],Tt={class:"orders-section"},St={key:0,class:"loading-placeholder"},Ut={key:1,class:"orders-list"},Nt=["onClick"],Lt={class:"order-header"},Ft={class:"order-basic"},Et={class:"order-number"},Bt={class:"order-time"},At={class:"order-content"},It={class:"order-amounts"},Rt={class:"amount-item"},Yt={class:"label"},Vt={class:"value"},xt={class:"amount-item"},zt={class:"label"},Gt={class:"value"},Wt={class:"amount-item"},jt={class:"value"},qt={key:0,class:"order-payment"},Jt={class:"value"},Qt={key:1,class:"order-bank"},Ht={class:"value"},Kt={class:"order-actions"},Xt=["onClick"],Zt=["onClick"],$t=["onClick"],te={key:2,class:"empty-orders"},ee={key:3,class:"pagination-section"},ne={class:"pagination-info"},oe={class:"pagination-controls"},ae=["disabled"],se={class:"page-numbers"},le=["onClick"],ie=["disabled"],re={class:"modal-header"},de={class:"modal-body"},ce={class:"order-info"},me={class:"order-summary"},ue={class:"summary-item"},ve={class:"summary-item"},fe={class:"summary-item"},pe={class:"form-group"},ye={key:0,class:"form-group"},ge={class:"modal-actions"},Ce=["disabled"],Pe={class:"modal-header"},be={class:"modal-body"},he={class:"payment-info"},_e={class:"payment-details"},ke={class:"detail-item"},De={class:"detail-item"},Oe={class:"amount"},Me={class:"detail-item"},we={class:"payment-proof"},Te={key:0,class:"upload-placeholder"},Se={key:1,class:"upload-preview"},Ue=["src"],Ne={class:"modal-actions"},Le=["disabled"];function Fe(p,e,m,n,h,_){var u,c,y,P,k,g;const b=it("router-link");return r(),i("div",pt,[t("div",yt,[t("div",gt,[t("div",Ct,[e[26]||(e[26]=t("h3",null,"訂單記錄",-1)),t("div",Pt,[t("span",bt,[e[24]||(e[24]=T(" 總訂單: ",-1)),t("strong",null,s(n.totalOrders),1)]),t("span",ht,[e[25]||(e[25]=T(" 本月成交: ",-1)),t("strong",null,s(n.monthlyOrders),1)])])]),t("div",_t,[t("div",kt,[(r(!0),i(L,null,F(n.filterTabs,o=>(r(),i("button",{key:o.value,class:S(["filter-tab",{active:n.activeFilter.type===o.value}]),onClick:d=>n.setActiveFilter("type",o.value)},[T(s(o.label)+" ",1),o.count>0?(r(),i("span",Ot,s(o.count),1)):C("",!0)],10,Dt))),128))]),t("div",Mt,[U(t("select",{"onUpdate:modelValue":e[0]||(e[0]=o=>n.activeFilter.status=o),onChange:e[1]||(e[1]=(...o)=>p.loadOrders&&p.loadOrders(...o))},[...e[27]||(e[27]=[I('<option value="" data-v-87006183>所有狀態</option><option value="PENDING" data-v-87006183>待處理</option><option value="PROCESSING" data-v-87006183>處理中</option><option value="COMPLETED" data-v-87006183>已完成</option><option value="CANCELLED" data-v-87006183>已取消</option><option value="FAILED" data-v-87006183>失敗</option>',6)])],544),[[A,n.activeFilter.status]]),U(t("input",{"onUpdate:modelValue":e[2]||(e[2]=o=>n.activeFilter.startDate=o),type:"date",onChange:e[3]||(e[3]=(...o)=>p.loadOrders&&p.loadOrders(...o))},null,544),[[E,n.activeFilter.startDate]]),U(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>n.activeFilter.endDate=o),type:"date",onChange:e[5]||(e[5]=(...o)=>p.loadOrders&&p.loadOrders(...o))},null,544),[[E,n.activeFilter.endDate]]),t("button",{class:"refresh-btn",onClick:e[6]||(e[6]=(...o)=>n.refreshOrders&&n.refreshOrders(...o)),disabled:n.loading},[t("i",{class:S(["icon-refresh",{spinning:n.loading}])},null,2),e[28]||(e[28]=T(" 刷新 ",-1))],8,wt)])])])]),t("div",Tt,[n.loading&&n.orders.length===0?(r(),i("div",St,[...e[29]||(e[29]=[t("div",{class:"loading-spinner"},null,-1),t("p",null,"載入中...",-1)])])):n.orders.length>0?(r(),i("div",Ut,[(r(!0),i(L,null,F(n.orders,o=>(r(),i("div",{key:o.id,class:"order-card",onClick:d=>n.viewOrderDetail(o.id)},[t("div",Lt,[t("div",Ft,[t("div",{class:S(["order-type",o.orderType.toLowerCase()])},s(o.orderType==="BUY"?"買入":"賣出"),3),t("div",Et,s(o.orderNumber),1),t("div",Bt,s(n.formatDateTime(o.createdAt)),1)]),t("div",{class:S(["order-status",o.status.toLowerCase()])},[e[30]||(e[30]=t("div",{class:"status-dot"},null,-1)),t("span",null,s(n.getStatusText(o.status)),1)],2)]),t("div",At,[t("div",It,[t("div",Rt,[t("span",Yt,s(o.orderType==="BUY"?"支付金額":"賣出數量"),1),t("span",Vt,s(o.orderType==="BUY"?n.formatPrice(o.amount):n.formatCrypto(o.usdtAmount)+" USDT"),1)]),t("div",xt,[t("span",zt,s(o.orderType==="BUY"?"獲得USDT":"獲得金額"),1),t("span",Gt,s(o.orderType==="BUY"?n.formatCrypto(o.usdtAmount)+" USDT":n.formatPrice(o.amount)),1)]),t("div",Wt,[e[31]||(e[31]=t("span",{class:"label"},"成交價格",-1)),t("span",jt,s(n.formatPrice(o.price)),1)])]),o.paymentMethod?(r(),i("div",qt,[e[32]||(e[32]=t("span",{class:"label"},"支付方式:",-1)),t("span",Jt,s(n.getPaymentMethodText(o.paymentMethod)),1)])):C("",!0),o.receivingBank?(r(),i("div",Qt,[e[33]||(e[33]=t("span",{class:"label"},"收款銀行:",-1)),t("span",Ht,s(o.receivingBank),1)])):C("",!0)]),t("div",Kt,[t("button",{class:"detail-btn",onClick:O(d=>n.viewOrderDetail(o.id),["stop"])}," 查看詳情 ",8,Xt),n.canCancelOrder(o)?(r(),i("button",{key:0,class:"cancel-btn",onClick:O(d=>n.showCancelModal(o),["stop"])}," 取消訂單 ",8,Zt)):C("",!0),n.canConfirmPayment(o)?(r(),i("button",{key:1,class:"confirm-btn",onClick:O(d=>n.showPaymentModal(o),["stop"])}," 確認支付 ",8,$t)):C("",!0)])],8,Nt))),128))])):(r(),i("div",te,[e[35]||(e[35]=t("div",{class:"empty-icon"},[t("i",{class:"icon-inbox"})],-1)),e[36]||(e[36]=t("h3",null,"暫無訂單記錄",-1)),e[37]||(e[37]=t("p",null,"您還沒有任何交易訂單",-1)),rt(b,{to:"/trading",class:"start-trading-btn"},{default:dt(()=>[...e[34]||(e[34]=[T(" 開始交易 ",-1)])]),_:1})])),n.orders.length>0&&n.pagination.total>n.pagination.pageSize?(r(),i("div",ee,[t("div",ne," 顯示第 "+s((n.pagination.current-1)*n.pagination.pageSize+1)+" - "+s(Math.min(n.pagination.current*n.pagination.pageSize,n.pagination.total))+" 項， 共 "+s(n.pagination.total)+" 項 ",1),t("div",oe,[t("button",{disabled:n.pagination.current<=1,onClick:e[7]||(e[7]=o=>n.changePage(n.pagination.current-1))}," 上一頁 ",8,ae),t("span",se,[(r(!0),i(L,null,F(n.visiblePages,o=>(r(),i("button",{key:o,class:S(["page-btn",{active:o===n.pagination.current}]),onClick:d=>n.changePage(o)},s(o),11,le))),128))]),t("button",{disabled:n.pagination.current>=n.pagination.pages,onClick:e[8]||(e[8]=o=>n.changePage(n.pagination.current+1))}," 下一頁 ",8,ie)])])):C("",!0)]),n.showCancelOrderModal?(r(),i("div",{key:0,class:"modal-overlay",onClick:e[15]||(e[15]=o=>n.showCancelOrderModal=!1)},[t("div",{class:"modal cancel-modal",onClick:e[14]||(e[14]=O(()=>{},["stop"]))},[t("div",re,[e[38]||(e[38]=t("h3",null,"取消訂單",-1)),t("button",{class:"close-btn",onClick:e[9]||(e[9]=o=>n.showCancelOrderModal=!1)},"×")]),t("div",de,[t("div",ce,[e[42]||(e[42]=t("p",null,"您確定要取消以下訂單嗎？",-1)),t("div",me,[t("div",ue,[e[39]||(e[39]=t("span",null,"訂單號:",-1)),t("span",null,s((u=n.selectedOrder)==null?void 0:u.orderNumber),1)]),t("div",ve,[e[40]||(e[40]=t("span",null,"類型:",-1)),t("span",null,s(((c=n.selectedOrder)==null?void 0:c.orderType)==="BUY"?"買入":"賣出"),1)]),t("div",fe,[e[41]||(e[41]=t("span",null,"金額:",-1)),t("span",null,s(((y=n.selectedOrder)==null?void 0:y.orderType)==="BUY"?n.formatPrice(n.selectedOrder.amount):n.formatCrypto(n.selectedOrder.usdtAmount)+" USDT"),1)])])]),t("div",pe,[e[44]||(e[44]=t("label",null,"取消原因",-1)),U(t("select",{"onUpdate:modelValue":e[10]||(e[10]=o=>n.cancelReason=o)},[...e[43]||(e[43]=[I('<option value="" data-v-87006183>請選擇取消原因</option><option value="price_change" data-v-87006183>價格變動</option><option value="payment_issue" data-v-87006183>支付問題</option><option value="change_mind" data-v-87006183>改變主意</option><option value="other" data-v-87006183>其他原因</option>',5)])],512),[[A,n.cancelReason]])]),n.cancelReason==="other"?(r(),i("div",ye,[e[45]||(e[45]=t("label",null,"詳細說明",-1)),U(t("textarea",{"onUpdate:modelValue":e[11]||(e[11]=o=>n.cancelReasonDetail=o),placeholder:"請詳細說明取消原因"},null,512),[[E,n.cancelReasonDetail]])])):C("",!0),t("div",ge,[t("button",{class:"cancel-btn",onClick:e[12]||(e[12]=o=>n.showCancelOrderModal=!1)}," 返回 "),t("button",{class:"confirm-btn",onClick:e[13]||(e[13]=(...o)=>n.confirmCancelOrder&&n.confirmCancelOrder(...o)),disabled:!n.cancelReason||n.cancelling},s(n.cancelling?"取消中...":"確認取消"),9,Ce)])])])])):C("",!0),n.showPaymentConfirmModal?(r(),i("div",{key:1,class:"modal-overlay",onClick:e[23]||(e[23]=o=>n.showPaymentConfirmModal=!1)},[t("div",{class:"modal payment-modal",onClick:e[22]||(e[22]=O(()=>{},["stop"]))},[t("div",Pe,[e[46]||(e[46]=t("h3",null,"確認支付",-1)),t("button",{class:"close-btn",onClick:e[16]||(e[16]=o=>n.showPaymentConfirmModal=!1)},"×")]),t("div",be,[t("div",he,[e[50]||(e[50]=t("h4",null,"支付信息",-1)),t("div",_e,[t("div",ke,[e[47]||(e[47]=t("span",null,"訂單號:",-1)),t("span",null,s((P=n.selectedOrder)==null?void 0:P.orderNumber),1)]),t("div",De,[e[48]||(e[48]=t("span",null,"應付金額:",-1)),t("span",Oe,s(n.formatPrice((k=n.selectedOrder)==null?void 0:k.amount)),1)]),t("div",Me,[e[49]||(e[49]=t("span",null,"支付方式:",-1)),t("span",null,s(n.getPaymentMethodText((g=n.selectedOrder)==null?void 0:g.paymentMethod)),1)])])]),t("div",we,[e[52]||(e[52]=t("h4",null,"上傳支付憑證",-1)),t("div",{class:"upload-area",onClick:e[18]||(e[18]=(...o)=>n.triggerPaymentProofUpload&&n.triggerPaymentProofUpload(...o))},[n.paymentProof?(r(),i("div",Se,[t("img",{src:n.paymentProof.preview,alt:"支付憑證"},null,8,Ue),t("button",{onClick:e[17]||(e[17]=O((...o)=>n.removePaymentProof&&n.removePaymentProof(...o),["stop"])),class:"remove-btn"},"×")])):(r(),i("div",Te,[...e[51]||(e[51]=[t("i",{class:"icon-upload"},null,-1),t("p",null,"點擊上傳支付截圖或收據",-1),t("span",{class:"upload-hint"},"支持 JPG、PNG，大小不超過5MB",-1)])]))]),t("input",{ref:"paymentProofInput",type:"file",accept:"image/*",onChange:e[19]||(e[19]=(...o)=>n.handlePaymentProofUpload&&n.handlePaymentProofUpload(...o)),hidden:""},null,544)]),e[53]||(e[53]=t("div",{class:"payment-notes"},[t("h4",null,"重要提醒"),t("ul",null,[t("li",null,"請確保已完成實際支付"),t("li",null,"上傳清晰的支付憑證截圖"),t("li",null,"支付憑證將用於人工審核"),t("li",null,"虛假支付憑證可能導致賬戶限制")])],-1)),t("div",Ne,[t("button",{class:"cancel-btn",onClick:e[20]||(e[20]=o=>n.showPaymentConfirmModal=!1)}," 取消 "),t("button",{class:"confirm-btn",onClick:e[21]||(e[21]=(...o)=>n.confirmPayment&&n.confirmPayment(...o)),disabled:!n.paymentProof||n.confirming},s(n.confirming?"確認中...":"確認支付"),9,Le)])])])])):C("",!0)])}const Ye=vt(ft,[["render",Fe],["__scopeId","data-v-87006183"]]);export{Ye as default};
